# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

#name: MSBuild

#on:
#  push:
#    branches: [ "master" ]
#  pull_request:
#    branches: [ "master" ]

#env:
  # Path to the solution file relative to the root of the project.
#  SOLUTION_FILE_PATH: .

  # Configuration type to build.
  # You can convert this to a build matrix if you need coverage of multiple configuration types.
  # https://docs.github.com/actions/learn-github-actions/managing-complex-workflows#using-a-build-matrix
#  BUILD_CONFIGURATION: Release

#permissions:
#  contents: read

#jobs:
#  build:
#    runs-on: windows-latest

#    steps:
#    - uses: actions/checkout@v4

#    - name: Add MSBuild to PATH
#      uses: microsoft/setup-msbuild@v1.0.2

#    - name: Restore NuGet packages
#      working-directory: ${{env.GITHUB_WORKSPACE}}
#      run: nuget restore ${{env.SOLUTION_FILE_PATH}}

#    - name: Build
#      working-directory: ${{env.GITHUB_WORKSPACE}}
      # Add additional options to the MSBuild command line here (like platform or verbosity level).
      # See https://docs.microsoft.com/visualstudio/msbuild/msbuild-command-line-reference
#      run: msbuild /m /p:Configuration=${{env.BUILD_CONFIGURATION}} ${{env.SOLUTION_FILE_PATH}}



name: CI Build for S1-Mod

# åœ¨ push å’Œæ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œ  main, 
on:
  push:
    branches: [ "master" ] 
  workflow_dispatch:

jobs:
  build-windows:
    # ä½¿ç”¨æœ€æ–°çš„ Windows Runner
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç å¹¶æ›´æ–°å­æ¨¡å— (Checkout & Submodules)
      uses: actions/checkout@v5
      with:
        submodules: true # ç¡®ä¿æ‹‰å–ä¾èµ–çš„å­æ¨¡å—
        
    - name: ğŸ› ï¸ è®¾ç½® Premake5 (Setup Premake5)
      # ä½¿ç”¨ GitHub Action è‡ªåŠ¨ä¸‹è½½å¹¶è®¾ç½® Premake5 åˆ° PATH
      uses: abel0b/setup-premake@v2
      with:
        # æ‚¨å¯ä»¥æŒ‡å®š Premake5 çš„ç‰ˆæœ¬ï¼Œä¾‹å¦‚ '5.0.0-beta2'
        # å¦‚æœä¸æŒ‡å®šï¼Œå®ƒä¼šå°è¯•è·å–æœ€æ–°ç‰ˆæœ¬
        version: '5.0.0-beta2' 
        
    - name: âš™ï¸ è¿è¡Œ Premake5 ç”Ÿæˆ Visual Studio è§£å†³æ–¹æ¡ˆ
      # ä½¿ç”¨é¡¹ç›® README ä¸­æŒ‡å®šçš„ç”Ÿæˆå™¨
      run: premake5 vs2022
        
    - name: ğŸ”¨ ä½¿ç”¨ MSBuild ç¼–è¯‘é¡¹ç›® (Build Project)
      # ä½¿ç”¨ MSBuild ç¼–è¯‘ç”Ÿæˆçš„è§£å†³æ–¹æ¡ˆæ–‡ä»¶ï¼Œç¡®ä¿ä½¿ç”¨ Release/x64 é…ç½®
      # windows-latest è¿è¡Œå™¨é»˜è®¤å®‰è£…äº† MSBuild
      run: |
        msbuild build\s1-mod.sln /p:Configuration=Release /p:Platform=x64 /m
        
    - name: ğŸ“ æŸ¥æ‰¾ç¼–è¯‘äº§ç‰©è·¯å¾„ (Set Artifact Path)
      # âš ï¸ å…³é”®æ­¥éª¤ï¼šè¯·æ ¹æ®æ‚¨çš„ Premake5 é…ç½®è°ƒæ•´è·¯å¾„ï¼
      # å‡è®¾ç¼–è¯‘ç»“æœåœ¨ build\Bin\x64\Release\s1-mod.exe
      id: set_path
      run: |
        $BinaryDir = "build\Bin\x64\Release"
        $ExeFile = "$BinaryDir\s1-mod.exe"
        
        # éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨ (å¯é€‰ä½†æ¨è)
        if (-not (Test-Path $ExeFile)) {
            Write-Host "é”™è¯¯: ç¼–è¯‘äº§ç‰©æœªæ‰¾åˆ°åœ¨ $ExeFile"
            exit 1
        }
        echo "BINARY_PATH=$ExeFile" >> $env:GITHUB_ENV

    - name: â¬†ï¸ ä¸Šä¼ ç¼–è¯‘äº§ç‰©ä¸º Artifact (Upload Artifact)
      uses: actions/upload-artifact@v4
      with:
        name: s1-mod-windows-x64-release # Artifact åç§°
        path: ${{ env.BINARY_PATH }}      # ç¼–è¯‘å¥½çš„æ–‡ä»¶è·¯å¾„
        retention-days: 7                 # Artifact ä¿ç•™ 7 å¤©

